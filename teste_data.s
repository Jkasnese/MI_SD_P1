.data

# Alocating space to crc lookup table
tabela: .word 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF,0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF,0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF,0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF,0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF,0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF,0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF,0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF,0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF,0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF,0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF,0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF,0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF

# Msg to have a CRC calculated for
msg: .byte 0x4c, 0x75, 0x74, 0x65, 0x69, 0x20, 0x70, 0x72, 0x61, 0x20, 0x65, 0x6e, 0x74, 0x72, 0x61, 0x72, 0x20, 0x65, 0x20, 0x6e, 0x61, 0x6f, 0x20, 0x76, 0x6f, 0x75, 0x20, 0x73, 0x61, 0x69, 0x72, 0x20, 0x4f, 0x73, 0x20, 0x71, 0x75, 0x65, 0x20, 0x6e, 0x61, 0x6f, 0x20, 0x70, 0x65, 0x72, 0x74, 0x65, 0x6e, 0x63, 0x65, 0x6d, 0x2c, 0x20, 0x65, 0x75, 0x20, 0x64, 0x65, 0x76, 0x6f, 0x6c, 0x76, 0x69, 0x20, 0x41, 0x63, 0x69, 0x64, 0x6f, 0x20, 0x6e, 0x6f, 0x20, 0x6d, 0x65, 0x74, 0x61, 0x6c, 0x2c, 0x20, 0x63, 0x61, 0x75, 0x73, 0x61, 0x20, 0x65, 0x66, 0x65, 0x69, 0x74, 0x6f, 0x20, 0x6c, 0x65, 0x74, 0x61, 0x6c, 0x54, 0x65, 0x74, 0x6f, 0x20, 0x42, 0x61, 0x69, 0x78, 0x6f, 0x20, 0x74, 0x65, 0x20, 0x65, 0x73, 0x70, 0x72, 0x65, 0x6d, 0x65, 0x20, 0x65, 0x20, 0x72, 0x65, 0x73, 0x70, 0x69, 0x72, 0x61, 0x20, 0x51, 0x75, 0x65, 0x6d, 0x20, 0x70, 0x69, 0x72, 0x61, 0x20, 0x74, 0x61, 0x20, 0x6e, 0x61, 0x20, 0x6d, 0x69, 0x72, 0x61, 0x20, 0x64, 0x61, 0x20, 0x6d, 0x69, 0x6e, 0x68, 0x61, 0x20, 0x66, 0x69, 0x72, 0x6d, 0x61, 0x20, 0x45, 0x6e, 0x74, 0x61, 0x6f, 0x20, 0x6d, 0x65, 0x20, 0x65, 0x73, 0x70, 0x65, 0x72, 0x61, 0x20, 0x72, 0x65, 0x63, 0x75, 0x70, 0x65, 0x72, 0x61, 0x72, 0x20, 0x6f, 0x20, 0x66, 0x6f, 0x6c, 0x65, 0x67, 0x6f, 0x20, 0x53, 0x65, 0x20, 0x63, 0x6f, 0x6d, 0x69, 0x67, 0x6f, 0x20, 0x6e, 0x61, 0x6f, 0x20, 0x6d, 0x6f, 0x72, 0x72, 0x65, 0x2c, 0x20, 0x6e, 0x75, 0x6e, 0x63, 0x61, 0x20, 0x63, 0x61, 0x69, 0x2c, 0x20, 0x6e, 0x61, 0x6f, 0x20, 0x74, 0x65, 0x6e, 0x74, 0x61, 0x20, 0x61, 0x20, 0x73, 0x6f, 0x72, 0x74, 0x65, 0x20, 0x57, 0x6f, 0x6f, 0x64, 0x73, 0x74, 0x6f, 0x63, 0x6b, 0x20, 0x6e, 0x75, 0x6d, 0x20, 0x66, 0x6c, 0x6f, 0x77, 0x20, 0x6d, 0x65, 0x74, 0x6f, 0x64, 0x69, 0x63, 0x6f, 0x20, 0x44, 0x6f, 0x72, 0x20, 0x6e, 0x61, 0x6f, 0x20, 0x65, 0x20, 0x70, 0x72, 0x61, 0x20, 0x71, 0x75, 0x65, 0x6d, 0x20, 0x71, 0x75, 0x65, 0x72, 0x2c, 0x20, 0x64, 0x6f, 0x72, 0x20, 0x65, 0x20, 0x70, 0x72, 0x61, 0x20, 0x71, 0x75, 0x65, 0x6d, 0x20, 0x70, 0x6f, 0x64, 0x65, 0x20, 0x45, 0x20, 0x6e, 0x6f, 0x73, 0x73, 0x6f, 0x20, 0x64, 0x65, 0x73, 0x74, 0x69, 0x6e, 0x6f, 0x20, 0x65, 0x20, 0x75, 0x6d, 0x61, 0x20, 0x63, 0x61, 0x69, 0x78, 0x61, 0x20, 0x64, 0x65, 0x20, 0x73, 0x75, 0x72, 0x70, 0x72, 0x65, 0x73, 0x61, 0x20, 0x4c, 0x65, 0x6f, 0x70, 0x61, 0x72, 0x64, 0x6f, 0x20, 0x6f, 0x75, 0x20, 0x5a, 0x65, 0x62, 0x72, 0x61, 0x3f, 0x20, 0x4d, 0x65, 0x20, 0x64, 0x69, 0x7a, 0x3a, 0x20, 0x43, 0x65, 0x20, 0x71, 0x75, 0x65, 0x72, 0x20, 0x73, 0x65, 0x72, 0x20, 0x70, 0x72, 0x65, 0x64, 0x61, 0x64, 0x6f, 0x72, 0x20, 0x6f, 0x75, 0x20, 0x70, 0x72, 0x65, 0x73, 0x61, 0x3f, 0x20, 0x41, 0x73, 0x73, 0x69, 0x6d, 0x2c, 0x20, 0x6f, 0x20, 0x50, 0x65, 0x72, 0x63, 0x6f, 0x72, 0x72, 0x69, 0x20, 0x70, 0x65, 0x6c, 0x61, 0x20, 0x62, 0x65, 0x69, 0x72, 0x61, 0x64, 0x61, 0x20, 0x61, 0x74, 0x65, 0x20, 0x61, 0x20, 0x73, 0x6f, 0x72, 0x74, 0x65, 0x20, 0x6d, 0x65, 0x20, 0x64, 0x69, 0x7a, 0x65, 0x72, 0x20, 0x4d, 0x65, 0x6e, 0x69, 0x6e, 0x6f, 0x2c, 0x20, 0x76, 0x6f, 0x63, 0x65, 0x20, 0x74, 0x65, 0x6d, 0x20, 0x6f, 0x20, 0x61, 0x76, 0x61, 0x6c, 0x20, 0x4e, 0x6f, 0x20, 0x74, 0x65, 0x6d, 0x70, 0x6f, 0x20, 0x65, 0x73, 0x73, 0x65, 0x6e, 0x63, 0x69, 0x61, 0x2c, 0x20, 0x73, 0x65, 0x20, 0x65, 0x75, 0x20, 0x65, 0x6c, 0x65, 0x76, 0x6f, 0x20, 0x6e, 0x6f, 0x20, 0x70, 0x65, 0x69, 0x74, 0x6f, 0x20, 0x4f, 0x20, 0x65, 0x78, 0x63, 0x65, 0x73, 0x73, 0x6f, 0x20, 0x65, 0x20, 0x65, 0x73, 0x73, 0x65, 0x6e, 0x63, 0x69, 0x61, 0x6c, 0x20, 0x45, 0x20, 0x6d, 0x75, 0x69, 0x74, 0x6f, 0x20, 0x62, 0x6f, 0x6d, 0x20, 0x6e, 0x61, 0x6f, 0x20, 0x73, 0x65, 0x20, 0x61, 0x63, 0x6f, 0x6d, 0x6f, 0x64, 0x61, 0x72, 0x20, 0x53, 0x61, 0x74, 0x69, 0x73, 0x66, 0x61, 0x63, 0x61, 0x6f, 0x20, 0x73, 0x65, 0x20, 0x6f, 0x20, 0x76, 0x65, 0x72, 0x73, 0x6f, 0x20, 0x65, 0x63, 0x6f, 0x61, 0x2c, 0x20, 0x76, 0x65, 0x6e, 0x74, 0x6f, 0x20, 0x65, 0x6d, 0x20, 0x70, 0x6f, 0x70, 0x61, 0x20, 0x4e, 0x61, 0x6f, 0x20, 0x76, 0x6f, 0x75, 0x20, 0x6d, 0x65, 0x20, 0x70, 0x6f, 0x75, 0x70, 0x61, 0x72, 0x2c, 0x20, 0x65, 0x6e, 0x74, 0x61, 0x6f, 0x20, 0x64, 0x65, 0x6d, 0x6f, 0x72, 0x6f, 0x75, 0x20, 0x6d, 0x65, 0x75, 0x20, 0x6d, 0x61, 0x6e, 0x6f, 0x20, 0x4c, 0x65, 0x74, 0x27, 0x73, 0x20, 0x67, 0x6f, 0x20, 0x51, 0x75, 0x65, 0x72, 0x6f, 0x20, 0x71, 0x75, 0x65, 0x20, 0x73, 0x65, 0x20, 0x66, 0x6f, 0x64, 0x61, 0x20, 0x6f, 0x20, 0x71, 0x75, 0x65, 0x20, 0x64, 0x69, 0x73, 0x73, 0x65, 0x72, 0x20, 0x54, 0x61, 0x20, 0x64, 0x65, 0x20, 0x70, 0x65, 0x2c, 0x20, 0x76, 0x6f, 0x75, 0x20, 0x6d, 0x61, 0x6e, 0x74, 0x65, 0x6e, 0x64, 0x6f, 0x20, 0x61, 0x20, 0x66, 0x65, 0x20, 0x61, 0x74, 0x65, 0x20, 0x44, 0x6f, 0x20, 0x6d, 0x65, 0x75, 0x20, 0x6c, 0x61, 0x64, 0x6f, 0x20, 0x65, 0x75, 0x20, 0x76, 0x6f, 0x75, 0x20, 0x63, 0x6f, 0x72, 0x72, 0x65, 0x6e, 0x64, 0x6f, 0x20, 0x69, 0x67, 0x75, 0x61, 0x6c, 0x20, 0x72, 0x61, 0x6c, 0x65, 0x20, 0x41, 0x64, 0x69, 0x76, 0x69, 0x6e, 0x68, 0x61, 0x20, 0x6f, 0x20, 0x71, 0x75, 0x65, 0x20, 0x74, 0x75, 0x20, 0x71, 0x75, 0x65, 0x72, 0x20, 0x56, 0x61, 0x67, 0x61, 0x62, 0x75, 0x6e, 0x64, 0x6f, 0x20, 0x71, 0x75, 0x65, 0x72, 0x2c, 0x20, 0x6d, 0x61, 0x73, 0x20, 0x65, 0x20, 0x71, 0x75, 0x65, 0x6d, 0x20, 0x6e, 0x61, 0x6f, 0x20, 0x71, 0x75, 0x65, 0x72, 0x2c, 0x20, 0x6e, 0x65, 0x3f, 0x20, 0x51, 0x75, 0x65, 0x72, 0x6f, 0x20, 0x76, 0x65, 0x72, 0x20, 0x64, 0x69, 0x6e, 0x68, 0x65, 0x69, 0x72, 0x6f, 0x20, 0x6e, 0x61, 0x20, 0x72, 0x65, 0x73, 0x70, 0x6f, 0x6e, 0x73, 0x61, 0x2c, 0x20, 0x73, 0x65, 0x72, 0x20, 0x61, 0x6d, 0x69, 0x67, 0x6f, 0x20, 0x64, 0x61, 0x20, 0x6f, 0x6e, 0x63, 0x61, 0x20, 0x4a, 0x61, 0x63, 0x61, 0x72, 0x65, 0x20, 0x71, 0x75, 0x65, 0x20, 0x70, 0x61, 0x6e, 0x67, 0x75, 0x61, 0x20, 0x76, 0x69, 0x72, 0x61, 0x20, 0x62, 0x6f, 0x6c, 0x73, 0x61, 0x20, 0x4d, 0x61, 0x6e, 0x6f, 0x2c, 0x20, 0x65, 0x6e, 0x74, 0x61, 0x6f, 0x20, 0x6d, 0x65, 0x20, 0x6d, 0x6f, 0x73, 0x74, 0x72, 0x61, 0x20, 0x61, 0x20, 0x63, 0x61, 0x72, 0x61, 0x20, 0x65, 0x6d, 0x20, 0x63, 0x6f, 0x6e, 0x76, 0x69, 0x76, 0x65, 0x6e, 0x63, 0x69, 0x61, 0x20, 0x63, 0x6f, 0x6d, 0x20, 0x6d, 0x61, 0x6c, 0x61, 0x6e, 0x64, 0x72, 0x6f, 0x20, 0x71, 0x75, 0x65, 0x20, 0x6a, 0x61, 0x20, 0x66, 0x6f, 0x69, 0x20, 0x64, 0x61, 0x20, 0x66, 0x6f, 0x73, 0x73, 0x61

.text
.global main 

main:

# Algorithm Configurations
movia r1, 0x100 # Table size in words = 2^8.
movui r4, 0x8 # Number of divisions or number of bits operated together on CRC algorithm 
movia r17, 0x30000 # initial table position (given by JNios)
# Initializing r9 to hold the poly
movui r9, 0x04C1
slli r9, r9, 0x10
ori r9, r9, 0x1DB7


# TABLE CALCULATION
mov r7, r17 # r7 gets permanent table position to iterate upon

movui r2, 0x0 # i=0. Will be incremented until table size.


# Table's FOR

next_number:
  bgeu r2, r1, calc_crc # If i >= 256, table is over. Go to algorithm

mov r3, r2 # r3 == rem, rem=i

slli r3, r3, 0x18 # Makes it the top byto to be shifted left

movui r5, 0x0 # j = 0

# XOR's FOR

next_div:
  bge r5, r4, store_number # If already checked all the bits, store number.
  
andhi r6, r3, 0x8000 # compare msb
slli r3, r3, 0x1
beq r0, r6, 0x4
xor r3, r3, r9
addi r5, r5, 0x1
br next_div

store_number:
  stw r3, 0(r7)

addi r2, r2, 0x1
addi r7, r7, 0x4 # Each position is 4 bytes in size (32 bits size)

br next_number

# END XOR FOR

# END TABLE CALCULATION


# CRC CALCULATION

calc_crc: 
  movia r1, msg

movia r2, 0xFFFFFFFF # initial xor

movi r3, 0x0 # i

movia r10, 0xFF # low_byte mask. Não é mais rápido fazer andi?

movia r8, 0x8 # repeat 1000 times. 8000 (msg size) / 8 (xor size) = 3E8 # Não é mais rápido comparar com inteiro?

crc_loop:
  bge r3, r8, final_xor # Não é mais rápido comparar logo com inteiro?

mov r4, r2 # byte "leaving" register tru right. To be xored with msg

# gets r2 high byte into r4
andhi r4, r4, 0xFF00 # Não é mais rápido andi logo com inteiro?

slli r2, r2, 0x8 # removes most significant byte

ldbu r5, 0(r1) # Gets bytes from msg

srli r4, r4, 0x18

xor r4, r4, r5 # xor bytes from msg and reg

slli r4, r4, 0x2 # each table position has 4 bytes, so mul by 4

add r4, r4, r17 # r17 has first table address. r4 is table offset

ldw r6, 0(r4)

xor r2, r2, r6

addi r1, r1, 0x1 # points to next byte on msg

addi r3, r3, 0x1 # increment iteration counter

br crc_loop

final_xor:
  xori r2, r2, 0x0

# Rotates bits to show crc from MSB to LSB
# roli r2, r2, 0x4 # CONFERIR RESULTADO E MODO DE EXIBIÇÃO

stw r2, 0x3020(r0) # CONFERIR ENDEREÇO LED

# Ler botao em espera ocupada

# r13 eh estado anterior do botao
mov r13, r0

# r12 lê estado atual do botão
ler_botao:
  ldb r12, 0x3030(r0) # CONFERIR ENDEREÇO BOTAO

beq r12, r13, ler_botao

mov r13, r12

bne r12, r0, ler_botao

# Se passou daqui, da um delayzinho (debounce) e lê de novo.

movi r14, 100 # r14 armazena um valor a ser decrementado para alcançar um delay

delay:
subi r14, r14, 1
bne r14, r0, delay

# Se a nova leitura for igual significa que o sinal estabilizou e é pra passar mesmo, então segue o código.

ldb r14, 0x3030(r0)

bne r14, r12, ler_botao

# Se a leitura for diferente, ou era ruído (volta pra ler_botao) ou tá muito grande o delay, a gente diminui o delay

roli r2, r2, 0x4

stw r2, 0x3020(r0) # CONFERIR ENDEREÇO LED

br ler_botao
